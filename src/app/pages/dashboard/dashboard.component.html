<!-- src/app/pages/dashboard/dashboard.component.html -->
<div class="page-container">
  <h1>Budget Dashboard</h1>

  <!-- Account Summary Section -->
  <section class="dashboard-section">
    <div class="section-header foldable" (click)="toggleAccountSummary()">
      <h2>Account Balances</h2>
      <span class="expand-icon">{{ accountSummaryFolded ? 'â–º' : 'â–¼' }}</span>
    </div>

    <div *ngIf="!accountSummaryFolded">
      <div *ngIf="accountSummary.length > 0; else noAccounts" class="accounts-summary-grid">
        <div *ngFor="let account of accountSummary" class="account-summary-card">
          <h4>{{ account.org.name }}: {{ account.name }}</h4>
          <p>
            <strong>Balance:</strong> {{ account.balanceNum | currency:account.currency:'symbol':'1.2-2' }}
            <span *ngIf="account.availableBalanceNum !== undefined && account.availableBalanceNum !== account.balanceNum" class="balance-available">
              (Avail: {{ account.availableBalanceNum | currency:account.currency:'symbol':'1.2-2' }})
            </span>
          </p>
          <p class="last-updated">Last Updated: {{ account['balance-date'] | unixToDate }}</p>
        </div>
      </div>
      <ng-template #noAccounts>
        <p *ngIf="!isLoading && !errorMessage && hasStoredAccessDetails" class="no-data-message">
          <em>No account summary data available.</em>
        </p>
        <p *ngIf="!isLoading && !errorMessage && !hasStoredAccessDetails" class="no-data-message">
          <em>No account summary data available. Please connect to SimpleFin via the "Raw Data" page.</em>
        </p>
      </ng-template>
      <div *ngIf="isLoading && accountSummary.length === 0" class="loading-indicator">
          <em>Loading account summary...</em>
      </div>
    </div>
  </section>

  <!-- Buckets Overview Section -->
  <section class="dashboard-section">
    <h2>Budget Buckets</h2>
    <div *ngIf="categorizedBuckets.length > 0; else noBucketsMessage">
      <div *ngFor="let bucket of categorizedBuckets" class="bucket-card">
        <div class="bucket-header foldable" (click)="toggleTransactions(bucket)">
          <h3>{{ bucket.name }}</h3>
	  <div class="bucket-summary">
            <span>Total in Bucket: {{ bucket.totalAmount | currency:getBucketDisplayCurrency(bucket):'symbol':'1.2-2' }}</span>
            <span>({{ bucket.transactions.length }} transactions)</span>
            <span class="expand-icon">{{ bucket.expanded ? 'â–¼' : 'â–º' }}</span>
          </div>
        </div>

        <!-- GOAL DISPLAY SECTION -->
        <div *ngIf="bucket.goalIsActiveAndConfigured && bucket.goal" class="bucket-goal-info">
          <div class="goal-title">
            Goal:
            <span class="goal-type">
              {{ bucket.goal.goalType === GoalType.SAVINGS ? 'Save' : 'Limit Spending To' }}
              {{ bucket.goal.targetAmount | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }}
            </span>
            <span class="goal-period">({{ bucket.goalPeriodDisplayString }})</span>
          </div>
          
          <div class="goal-progress-container" *ngIf="bucket.goal && bucket.goal.targetAmount != null && bucket.goal.targetAmount > 0">
            <progress class="goal-progress-bar" 
                      [value]="bucket.goalAmountRelevant || 0" 
                      [max]="bucket.goal.targetAmount"
                      [class.savings]="bucket.goal.goalType === GoalType.SAVINGS"
                      [class.spending]="bucket.goal.goalType === GoalType.SPENDING_LIMIT"
                      [class.over-budget]="bucket.goal.goalType === GoalType.SPENDING_LIMIT && (bucket.goalAmountRelevant || 0) > bucket.goal.targetAmount"
                      [class.goal-met]="bucket.goalIsMetOrOnTrack">
            </progress>
            <div class="goal-progress-text">
              {{ bucket.goalAmountRelevant | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }} / 
              {{ bucket.goal.targetAmount | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }} 
              ({{ bucket.goalProgressPercentage | number:'1.0-0' }}%)
            </div>
          </div>
          <div *ngIf="bucket.goal && bucket.goal.targetAmount === 0 && bucket.goalAmountRelevant !== undefined" class="goal-progress-text">
              Current: {{ bucket.goalAmountRelevant | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }} 
              (Target is 0)
              <span *ngIf="bucket.goalIsMetOrOnTrack" class="goal-met-text"> âœ”</span>
          </div>

          <div class="goal-remaining">
            <ng-container *ngIf="bucket.goal.goalType === GoalType.SAVINGS">
              <span *ngIf="!bucket.goalIsMetOrOnTrack && bucket.goalAmountRemaining !== undefined">To Save: {{ bucket.goalAmountRemaining | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }}</span>
              <span *ngIf="bucket.goalIsMetOrOnTrack" class="goal-met-text">Goal Achieved! ðŸŽ‰</span>
              <span *ngIf="bucket.goalIsMetOrOnTrack && (bucket.goalAmountRelevant || 0) > bucket.goal.targetAmount">
                 (Exceeded by: {{ ((bucket.goalAmountRelevant || 0) - bucket.goal.targetAmount) | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }})
              </span>
            </ng-container>
            <ng-container *ngIf="bucket.goal.goalType === GoalType.SPENDING_LIMIT">
              <span *ngIf="bucket.goal && (bucket.goalAmountRelevant || 0) > bucket.goal.targetAmount" class="over-budget-text">
                Over Budget by: {{ ((bucket.goalAmountRelevant || 0) - bucket.goal.targetAmount) | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }} ðŸ˜Ÿ
              </span>
              <span *ngIf="bucket.goal && bucket.goalIsMetOrOnTrack && (bucket.goalAmountRelevant || 0) <= bucket.goal.targetAmount && bucket.goalAmountRemaining !== undefined">
                Remaining in Budget: {{ bucket.goalAmountRemaining | currency:getBucketDisplayCurrency(bucket) : 'symbol':'1.2-2' }}
              </span>
            </ng-container>
          </div>
        </div>
        <!-- END GOAL DISPLAY SECTION -->

        <div *ngIf="bucket.expanded" class="transactions-list">
          <div *ngIf="bucket.transactions.length > 0; else noTransactionsInBucketMessage">
            <table class="transactions-table-condensed">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Payee</th>
                  <th>Description</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let tx of bucket.transactions" [class.debit]="tx.amountNum !== undefined && tx.amountNum < 0" [class.credit]="tx.amountNum !== undefined && tx.amountNum >= 0">
                  <td class="tx-date">{{ tx.posted | unixToDate }}</td>
                  <td>{{ tx.payee || 'N/A' }}</td>
                  <td class="description-cell" title="{{tx.description}}">{{ tx.description }}</td>
                  <td class="amount">{{ tx.amountNum | currency:tx.currency:'symbol':'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noTransactionsInBucketMessage>
            <p><em>No transactions in this bucket for the current period.</em></p>
          </ng-template>
        </div>
      </div>
    </div>
    <ng-template #noBucketsMessage>
      <p *ngIf="!isLoading" class="no-data-message">No buckets configured yet. Go to <a routerLink="/setup">Setup/Config</a> to create some.</p>
    </ng-template>
    <div *ngIf="isLoading && categorizedBuckets.length === 0" class="loading-indicator">
      <em>Loading buckets and transactions...</em>
    </div>
  </section>
</div>
